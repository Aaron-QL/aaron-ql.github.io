<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="网络,TCP," />










<meta name="description" content="背景最近写的代理服务在Ctrl+C时不能正常的停止，进一步排查，发现是TCPListener.Close()被阻塞住没有正常返回，于是整理一篇文章讲下如何安全的关闭一个服务器的所有连接，使其优雅的退出。 问题排查1234567891011121314151617func main() &amp;#123;    &#x2F;&#x2F; 启动一个tcp server    s, _ :&#x3D; net.ResolveTCPAddr">
<meta property="og:type" content="article">
<meta property="og:title" content="如何优雅的关闭服务器">
<meta property="og:url" content="https://aaron-ql.github.io/articles/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1%E5%99%A8/index.html">
<meta property="og:site_name" content="Code Your Ambition">
<meta property="og:description" content="背景最近写的代理服务在Ctrl+C时不能正常的停止，进一步排查，发现是TCPListener.Close()被阻塞住没有正常返回，于是整理一篇文章讲下如何安全的关闭一个服务器的所有连接，使其优雅的退出。 问题排查1234567891011121314151617func main() &amp;#123;    &#x2F;&#x2F; 启动一个tcp server    s, _ :&#x3D; net.ResolveTCPAddr">
<meta property="og:locale">
<meta property="article:published_time" content="2022-01-23T06:05:37.000Z">
<meta property="article:modified_time" content="2022-03-01T11:45:12.000Z">
<meta property="article:author" content="Aaron Qin">
<meta property="article:tag" content="网络">
<meta property="article:tag" content="TCP">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://aaron-ql.github.io/articles/如何优雅的关闭服务器/"/>





  <title>如何优雅的关闭服务器 | Code Your Ambition</title>
  




<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZV2QP61MNB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZV2QP61MNB');
</script>






<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Code Your Ambition</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aaron-ql.github.io/articles/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code Your Ambition">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">如何优雅的关闭服务器</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-01-23T14:05:37+08:00">
                2022-01-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">踩坑记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/articles/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1%E5%99%A8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="articles/如何优雅的关闭服务器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近写的代理服务在<code>Ctrl+C</code>时不能正常的停止，进一步排查，发现是<code>TCPListener.Close()</code>被阻塞住没有正常返回，于是整理一篇文章讲下如何安全的关闭一个服务器的所有连接，使其优雅的退出。</p>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 启动一个tcp server</span></span><br><span class="line">    s, _ := net.ResolveTCPAddr(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:15001&quot;</span>)</span><br><span class="line">    l, _ := net.ListenTCP(<span class="string">&quot;tcp&quot;</span>, s)</span><br><span class="line">    <span class="comment">// 因为用作代理，配置了 IP_TRANSPARENT 选项</span></span><br><span class="line">    f, _ := l.File()</span><br><span class="line">    syscall.SetsockoptInt(<span class="keyword">int</span>(f.Fd()), syscall.SOL_IP, syscall.IP_TRANSPARENT, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _, e := l.AcceptTCP() <span class="comment">// 调用Accept接收连接，此协程按预期阻塞在这里</span></span><br><span class="line">        fmt.Println(e)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Second) <span class="comment">// 等待另一个协程阻塞在 Accept</span></span><br><span class="line">    ...</span><br><span class="line">    l.Close()               <span class="comment">// 程序接收到 Ctrl+C 的interrupt信号，主动关闭listener，期望能立即返回，但却被阻塞在了这里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>大致逻辑如上面的伪代码所示，查了一下发现有人和我遇到同样的问题：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/29277">net: UnixListener blocks forever in Close() if File() is used to get the file descriptor · Issue #29277 · golang/go · GitHub</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/dylanplecki">@dylanplecki</a> That makes perfect sense, thanks for the analysis! We noticed that the <code>Fd</code> was the culprit, didn’t realize that the <code>SetBlocking</code> the duplicated FD affected the original FD as well, that was the missing piece that leads to a simple workaround for our use-case – put the file back into non-blocking mode using <code>syscall.SetNonblock</code>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ianlancetaylor">@ianlancetaylor</a> We’re implementing a graceful restart feature (<a target="_blank" rel="noopener" href="https://www.haproxy.com/blog/truly-seamless-reloads-with-haproxy-no-more-hacks/">similar to HAProxy</a>), so we need to pass file descriptors from the old process to the new using a unix domain socket. I don’t think we can use <code>net.ListenConfig</code> here.</p>
<p>I think the issue comes down to:</p>
<ul>
<li><code>File()</code> returning a new file descriptor, but still referencing the same underlying file description – the documentation mentions a new file descriptor, and that changes may not affect the original. Maybe it should be more explicit in mentioning that they may share underlying state.</li>
<li>Calling <code>Fd()</code> on the duplicated <code>*os.File</code> sets the file description into blocking mode, but the original <code>internal/poll.FD</code> of the listener still has <code>isBlocking == 1</code>, since it doesn’t “realize” the underlying file descriptor is no longer non-blocking. On <code>Close()</code>, we enter this block:</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/internal/poll/fd_unix.go#L102">go/fd_unix.go at master · golang/go · GitHub</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wait until the descriptor is closed. If this was the only</span></span><br><span class="line"><span class="comment">// reference, it is already closed. Only wait if the file has</span></span><br><span class="line"><span class="comment">// not been set to blocking mode, as otherwise any current I/O</span></span><br><span class="line"><span class="comment">// may be blocking, and that would block the Close.</span></span><br><span class="line"><span class="comment">// No need for an atomic read of isBlocking, increfAndClose means</span></span><br><span class="line"><span class="comment">// we have exclusive access to fd.</span></span><br><span class="line"><span class="keyword">if</span> fd.isBlocking == <span class="number">0</span> &#123;</span><br><span class="line">  runtime_Semacquire(&amp;fd.csema)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As the comment says, this causes <code>Close()</code> to block, leading to the behaviour we see in the bug.</p>
<p>Even the original <code>internal/poll.FD</code> was updated to no longer be considered non-blocking as part of the <code>File()</code> + <code>Fd()</code> operations, the user may trigger changes that cause it to get out-of-sync (e.g., using <code>syscall.SetNonblock</code>).</p>
</blockquote>
<blockquote>
<p>Because in older versions of Go all files were in blocking mode, so calling the <code>Fd</code> method gave you a descriptor in blocking mode. A program has to know whether a descriptor is blocking or non-blocking in order to use it correctly, so for backward compatibility when we added the ability for pipes to use the poller we maintained the existing behavior of <code>Fd</code>: that it returned a descriptor in blocking mode.</p>
</blockquote>
<p>总计一下就是说：<code>File()</code>返回一个新的文件描述符，但仍引用相同的底层文件描述，在复制出来的文件描述符上调用<code>Fd()</code>会设置文件描述进入阻塞模式，但原本<code>TCPListener</code>的<code>internal/poll.FD</code>已经是<code>isBlocking == 1</code>，由于它没有“意识到”底层的文件描述已经不再阻塞，所以导致了<code>Close()</code>的阻塞。</p>
<p>解决方案是使用<code>SyscallConn</code>替代<code>File() + Fd()</code>的方式设置socket参数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">listener, err := net.ListenTCP(TCP, listenAddr)</span><br><span class="line">...</span><br><span class="line">rawConn, err := listener.SyscallConn()</span><br><span class="line">...</span><br><span class="line">rawConn.Control(<span class="function"><span class="keyword">func</span><span class="params">(fd <span class="keyword">uintptr</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err = syscall.SetsockoptInt(<span class="keyword">int</span>(fd), syscall.SOL_IP, syscall.IP_TRANSPARENT, <span class="number">1</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logger.Fatalf(<span class="string">&quot;syscall.SetsockoptInt(): %s&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="优雅关闭"><a href="#优雅关闭" class="headerlink" title="优雅关闭"></a>优雅关闭</h2><p>前面的部分只是解决了<code>TCPListener.Close()</code>阻塞的问题，能够让服务器不再接收新的TCP连接，可对于已经建立的连接我们还没有做处理，那我们该如何优雅的关闭一个TCP服务器呢？</p>
<p>Go提供了便捷的<code>socket</code>操作，通常一个<code>Server</code>如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listener := net.Listen(<span class="string">&quot;tcp&quot;</span>, ... address ...)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    conn := listener.Accept()</span><br><span class="line">    <span class="keyword">go</span> handler(conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler</code>是一个阻塞函数，它等待客户端的命令，执行所需的处理，并发送回相应给客户端。根据这种逻辑，”优雅”的关闭服务器是指在任何给定时间都在执行两个不同的功能：</p>
<ol>
<li><p>停止监听新的连接</p>
</li>
<li><p>停止处理已存在的连接</p>
</li>
</ol>
<p>对于第一步，我们可以通过<code>TCPListener.Close()</code>实现，但对于现有的连接呢？目前据我了解并没有一个简单高效的实现方案，如果有请告诉我。具体来说，最安全的方法是让正在关闭的服务器等待客户端关闭它们的连接。这是我们将首先介绍的方法。</p>
<h3 id="Step-1-等客户端关闭连接"><a href="#Step-1-等客户端关闭连接" class="headerlink" title="Step 1: 等客户端关闭连接"></a>Step 1: 等客户端关闭连接</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">  listener net.Listener</span><br><span class="line">  quit     <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">  wg       sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>)</span> *<span class="title">Server</span></span> &#123;</span><br><span class="line">  s := &amp;Server&#123;</span><br><span class="line">    quit: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;),</span><br><span class="line">  &#125;</span><br><span class="line">  l, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">  &#125;</span><br><span class="line">  s.listener = l</span><br><span class="line">  s.wg.Add(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">go</span> s.serve()</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的例子中，我们实现了一个简单的<code>Server</code>，通过<code>quit</code>这个channel接收关闭信号，并通过<code>sync.WaitGroup</code>等待多个<code>goroutine</code>真正的关闭。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">serve</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">defer</span> s.wg.Done()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    conn, err := s.listener.Accept()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> &lt;-s.quit:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        log.Println(<span class="string">&quot;accept error&quot;</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      s.wg.Add(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        s.handleConection(conn)</span><br><span class="line">        s.wg.Done()</span><br><span class="line">      &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个常见的<code>Accept</code>循环，除了增加了一个<code>select</code>逻辑。它通过读取<code>quit</code>这个channel来判断<code>Accept</code>返回的错误是否表示<code>Server</code>已关闭。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="built_in">close</span>(s.quit)</span><br><span class="line">  s.listener.Close()</span><br><span class="line">  s.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们要关闭Server时，先关闭<code>quit</code>这个channel，然后调用<code>listener.Close()</code>，<code>Accept()</code>就会返回一个错误，表示监听的服务已关闭，上面的select就会走到<code>&lt;-quit</code>这个case里。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">handleConection</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">  <span class="keyword">defer</span> conn.Close()</span><br><span class="line">  buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">2048</span>)</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    n, err := conn.Read(buf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != io.EOF &#123;</span><br><span class="line">      log.Println(<span class="string">&quot;read error&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    log.Printf(<span class="string">&quot;received from %v: %s&quot;</span>, conn.RemoteAddr(), <span class="keyword">string</span>(buf[:n]))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个简单的处理逻辑，服务端不停的从连接中读取信息，直到客户端主动关闭连接。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := NewServer(addr)</span><br><span class="line"><span class="comment">// do whatever here...</span></span><br><span class="line">s.Stop()</span><br></pre></td></tr></table></figure>

<p>这样实现的问题在于，如果客户端不主动关闭连接，服务器的<code>goroutine</code>就会一直阻塞在<code>Read</code>这个系统调用里，浪费服务器资源，并且<code>Stop()</code>的调用会被阻塞住，直到客户端主动关闭连接。</p>
<h3 id="Step-2-主动关闭连接"><a href="#Step-2-主动关闭连接" class="headerlink" title="Step 2: 主动关闭连接"></a>Step 2: 主动关闭连接</h3><p>现在我看一种更主动的实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">handleConection</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">  <span class="keyword">defer</span> conn.Close()</span><br><span class="line">  buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">2048</span>)</span><br><span class="line">ReadLoop:</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-s.quit:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      conn.SetDeadline(time.Now().Add(<span class="number">200</span> * time.Millisecond))</span><br><span class="line">      n, err := conn.Read(buf)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> opErr, ok := err.(*net.OpError); ok &amp;&amp; opErr.Timeout() &#123;</span><br><span class="line">          <span class="keyword">continue</span> ReadLoop</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != io.EOF &#123;</span><br><span class="line">          log.Println(<span class="string">&quot;read error&quot;</span>, err)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      log.Printf(<span class="string">&quot;received from %v: %s&quot;</span>, conn.RemoteAddr(), <span class="keyword">string</span>(buf[:n]))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种实现的关键在于对<code>conn</code>的操作设置了<code>SetDeadline</code>，保证读写操作都会在超时后放返回，在返回后检查这个错误是由超时引起它还是其他原因，如果是前者则再次进行循环。</p>
<p>这种方法是健壮的，因为我们（很可能）不会在客户端主动发送内容时关闭连接。它也很简单，因为它将所有额外的逻辑都限制在了 handleConnection 上。</p>
<p>当然，这种实现方式对服务器的性能会有一定的损耗，因为每隔200毫秒都要进行一次系统调用，每一次都会造成用户空间与内核空间的切换，造成一些成本，但还可以接受。更重要的是这保证了<code>Stop()</code>的调用最多也只会阻塞200毫秒就能回收其他所有的<code>goroutine</code>。当然，这个时间应该是设置成一个更合适的时间。</p>
<p>还有一个可选的方案是记录所有打开的连接，在调用<code>Stop()</code>时主动关闭它们。这可能会更有效，但代价是实现复杂性和缺乏稳健性。这样的<code>Stop</code>可以在客户端主动发送数据时轻松关闭连接，从而导致客户端错误。</p>
<p>这里其实可以参考<code>http.Server.Shutdown</code>方法，它的文档中进行了如下说明：</p>
<blockquote>
<p>Shutdown gracefully shuts down the server without interrupting any active connections. Shutdown works by first closing all open listeners, then closing all idle connections, and then waiting indefinitely for connections to return to idle and then shut down</p>
</blockquote>
<p>这里的“空闲”是指客户端在一段时间内没有发送任何请求。HTTP相较于TCP是更高级别的协议，所以它直到客户端的通信模式。在不同的协议中，关闭策略往往不同。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>对于TCP Server，使用<code>SetDeadline</code>保证<code>goroutine</code>不会阻塞在系统调用中，然后使用<code>sync.WaitGroup</code>保证所有<code>goroutine</code>都退出后再关闭。</p>
</li>
<li><p>使用更高级别的通信协议。</p>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/29277">net: UnixListener blocks forever in Close() if File() is used to get the file descriptor · Issue #29277 · golang/go · GitHub</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://pkg.go.dev/net#UnixListener.SyscallConn">net package - net - pkg.go.dev</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/28330">os: (*os.File).SetDeadline() doesn&#39;t work after io.Copy(*net.TCPConn, *os.File) · Issue #28330 · golang/go · GitHub</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2020/graceful-shutdown-of-a-tcp-server-in-go/">Graceful shutdown of a TCP server in Go - Eli Bendersky’s website</a></p>
</li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt=" 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a>
          
            <a href="/tags/TCP/" rel="tag"># TCP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/articles/TCP%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86%202/" rel="next" title="TCP知识点整理">
                <i class="fa fa-chevron-left"></i> TCP知识点整理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/articles/%E5%A4%A7%E6%B5%81%E9%87%8F%E7%BD%91%E7%BB%9C%E8%B4%9F%E8%BD%BD%E5%AF%B9%E9%9B%86%E7%BE%A4%E5%BD%B1%E5%93%8D%E7%9A%84%E6%B5%8B%E8%AF%95/" rel="prev" title="大流量网络负载对集群影响的测试">
                大流量网络负载对集群影响的测试 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="">
              
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index%202.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index%202.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Aaron-QL" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:aka.qin@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://coolshell.cn/" title="coolshell" target="_blank">coolshell</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://draveness.me/" title="draveness" target="_blank">draveness</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://morven.life/" title="Morven" target="_blank">Morven</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://strikefreedom.top/" title="潘少" target="_blank">潘少</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://colobu.com/" title="鸟窝" target="_blank">鸟窝</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ctimbai.github.io/" title="猿大白" target="_blank">猿大白</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://eddycjy.com/" title="煎鱼" target="_blank">煎鱼</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lessisbetter.site/" title="大彬" target="_blank">大彬</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tiancaiamao.gitbooks.io/go-internals/content/zh/" title="深入解析GO" target="_blank">深入解析GO</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">2.</span> <span class="nav-text">问题排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%AD"><span class="nav-number">3.</span> <span class="nav-text">优雅关闭</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-1-%E7%AD%89%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.1.</span> <span class="nav-text">Step 1: 等客户端关闭连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-2-%E4%B8%BB%E5%8A%A8%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.2.</span> <span class="nav-text">Step 2: 主动关闭连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Aaron Qin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://aaron-ql.github.io/articles/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1%E5%99%A8/';
          this.page.identifier = 'articles/如何优雅的关闭服务器/';
          this.page.title = '如何优雅的关闭服务器';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
